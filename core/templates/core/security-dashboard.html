{% extends 'core/base.html' %}
{% load static %}

{% block title %}Security Team Dashboard | 2FA Project{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'core/css/security.css' %}">

<div class="security-dashboard">
  <aside class="sidebar">
    <div class="logo">
      <h2>Security Panel</h2>
    </div>

    <nav class="menu">
      <ul>
        <li><a href="#audit-logs">Audit Logs</a></li>
        <li><a href="#monitor-compliance">Monitor Compliance</a></li>
        <li><a href="#analyze-activities">Analyze Activities</a></li>
        <li>
          <a href="#" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
            Logout
          </a>
        </li>
      </ul>
      <form id="logout-form" action="{% url 'logout' %}" method="post" style="display:none;">
        {% csrf_token %}
      </form>
    </nav>

    <div class="profile-section">
      <hr>
      <div class="team-profile">
        <img src="{% static 'core/images/profile.png' %}" alt="Security Team">
        <span>{{ request.user.get_full_name }}</span>
      </div>
    </div>
  </aside>

  <main class="main-content">

    <!-- AUDIT LOGS SECTION -->
    <section id="audit-logs" class="section">
      <h2>Audit Logs</h2>

      <div id="search">
        <input type="text" placeholder="Enter user name" name="search">
        <button>Search</button>
      </div>

      <table class="audit-logs-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Role</th>
            <th>Details</th>
            <th>Event Type</th>
            <th>IP Address</th>
            <th>Timestamp</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs %}
            <tr>
              <td>{{ log.user.get_full_name }}</td>
              <td>{{ log.user.role|capfirst }}</td>
              <td>{{ log.details|default:"-" }}</td>
              <td>{{ log.event_type }}</td>
              <td>{{ log.ip_address }}</td>
              <td>{{ log.timestamp|date:"Y-m-d H:i" }}</td>
              <td>
                {% if log.user %}
                  {% if log.user.is_active %}
                    <form method="post" action="{% url 'block-user' log.user.id %}" style="display:inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-block">Block</button>
                    </form>
                  {% else %}
                    <form method="post" action="{% url 'unblock-user' log.user.id %}" style="display:inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-unblock">Unblock</button>
                    </form>
                  {% endif %}
                {% else %}
                  <span class="text-danger">User not found</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="7">No logs found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <!-- COMPLIANCE MONITOR SECTION -->
    <section id="monitor-compliance" class="section" hidden>
      <h2>Compliance Monitor</h2>
      <p>Security compliance is currently at <strong>95%</strong>.</p>
      <ul>
        <li>ISO/IEC 27001: OK</li>
        <li>2FA Enforcement: OK</li>
        <li>Password Policy: Needs Review</li>
      </ul>
    </section>

    <!-- ACTIVITY ANALYSIS SECTION -->
    <section id="analyze-activities" class="section">
      {% if peak_hour or unusual_login_date or failed_attempts %}
        <h2>Activity Analysis</h2>
        <p>Analyzing system activity (past 7 days):</p>
        <ul>
          {% if peak_hour %}
            <li>Peak usage hour: {{ peak_hour }}:00 hrs</li>
          {% endif %}
          {% if unusual_login_date %}
            <li>Unusual login: {{ unusual_login_date }}</li>
          {% endif %}
          {% if failed_attempts %}
            <li>Failed login attempts: {{ failed_attempts }}</li>
          {% endif %}
        </ul>
      {% else %}
        <p>No significant activity to display from the past week.</p>
      {% endif %}
    </section>

  </main>
</div>

<script src="{% static 'core/js/security.js' %}"></script>
{% endblock %}
